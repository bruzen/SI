<!DOCTYPE html>
<meta charset="utf-8">
<head>
<script src="d3.js"></script>
<style type="text/css"></style>
<style type="text/css">
rect.car{
	background-color: black;
	width: 30px;
	height: 7px;
	}
rect.truck{
	background-color: red;
	width: 15px;
	height: 7px;
	}
rect.motorcycle{
	background-color: blue;
	width: 10px;
	height: 4px;
	}
</style></head>
<body>
<script>

	 var vcount = 25
		w = 750
		h = 200
		lanenumber = 7
		duration = 200
		speedlimit = 15
		cscale = d3.scale.linear().domain([0,1]).range([speedlimit - 7,speedlimit + 3])
		mscale = d3.scale.linear().domain([0,1]).range([speedlimit - 6,speedlimit + 2])
		tscale = d3.scale.linear().domain([0,1]).range([speedlimit - 8,speedlimit + 1])
		xscale = d3.scale.linear().domain([0,1]).range([15,w-15])
		vehicles = new Array()
		yscalerange = new Array();
	
	for( var i = 0; i < lanenumber; i++){
		yscalerange.push(15 + ((i / lanenumber) * (h-15)))}
	
	var	yscale = d3.scale.quantize().domain([0,lanenumber - 1]).range(yscalerange)
 	
 	var svg = d3.select("body")
 			.append("svg")
 			.attr("width", w)
 			.attr("height", h);
 
	function createVehicle(){
		var typeValue = d3.scale.threshold.domain([0.6, 0.8]).range([0,1,2])(Math.random());
		var type;
		var speedScale;
		var width;
		var height;
		var color;
		var stroke;
		var strokewidth;
		
	
		switch(typeValue) {//we want 3/5ths cars, and 1/5th each trucks and motorcycles
			case 0:
				type = "car";
				speedScale = cscale;
				width = 20;
				height = 8;
				color = "red";
				stroke = "black";
				strokewidth = 2;
				break;
			case 1:
				type = "truck";
				speedScale = tscale;
				width = 30;
				height = 8;
				color = "black";
				stroke = "grey";
				strokewidth = 2;
				break;
			case 2:
				type = "motorcycle";
				speedScale = mscale;
				width = 10;
				height = 4;
				color = "blue";
				stroke = "black";
				strokewidth = 1;
				break;
		}
		var speed = speedScale(Math.random());
		var lane = Math.floor(Math.random() * lanenumber)
		return {"type" : type, "speed": speed, "width": width, 
				"height": height, "color" : color, "stroke" : stroke, 
				"stroke-width" : strokewidth, "status" : 0, 
				"slowspeed" : speed, "lane" : lane, "currentspeed" : speed, "acceleration" : 3};
 	};
 	
 	/*
 	Status meanings:
 		0 - moving normally
 		1 - slowed for car in front
 		2 - stopped (error checking so cars aren't on top of each other)
 		3 - changing lanes
 	*/
 	
 	function createVehicles() {
 		var Vehicles = new Array()
 		for( var i = 0; i < vcount; i++){
 			Vehicles.push(createVehicle());
 		}
 		return Vehicles
 	};
 	
 	vehicles = createVehicles();
 	
 	svg.selectAll("rect")
 		.data(vehicles)
 		.enter()
 		.append("rect")
 		.attr("id", function(d, i){return "v" + i})
 		.attr("x", -35)
 		.attr("y", function(d){return yscale(d.lane)})
 		.attr("lane", function(d){return d.lane})
 		.attr("width", function(d){return d.width})
 		.attr("height", function(d){return d.height})
 		.style("color", function(d){return d.color})
 		.style("stroke", function(d){return d.stroke})
 		.style("stroke-width", function(d){return d.strokewidth})
 		.attr("fill", function(d){return d.color});
 	
 	function setSpeeds() {
 		svg.selectAll("rect").each(function(d,i){
 			var xpos = d3.select(this).attr("x");//x-position of the vehicle
 			var vwidth = d.width;//vehicle width
 			var speed;//current vehicle speed
 			switch(d.status){
 				case 0:
 				case 2:
 					speed = parseFloat(d.speed);
 				case 1:
 					speed = parseFloat(d.slowspeed);
 			}
 				
 			var element = this;
 			//cars that are close enough to need to start slowing down for
 			var closeCars = svg.selectAll("rect[lane='" + d.lane + "']").filter(
 				function(){return this != element && parseFloat(xpos) < d3.select(this).attr("x") && d3.select(this).attr("x") <= (parseFloat(xpos) + (3 * vwidth) + (3 * speed));});
 			//if there are no cars nearby move normally
 			if(kindaCloseCars.empty()){
 				d.status = 0;
 				d.slowspeed = d.speed;}
			//if you are on top of a car, error check to revert this
			else if(!closeCars.filter(function(){return d3.select(this).attr("x") <= (parseInt(xpos) + vwidth + 3);}).empty()){
 				d.status = 2;}
 			//if there are cars around you...
 			else {
 				//...check if there is space in the lane above you...
 				var upCars = svg.selectAll("rect[lane='"  + (d.lane + 1) + "']").filter(
					function(){
						var select = d3.select(this);
						var data = select.datum();
						var selectwidth = data.width;
						var selectspeed;
						switch(data.status){
							case 0:
								selectspeed = parseFloat(data.speed);
							case 1:
								selectspeed = parseFloat(data.slowspeed);
							case 2:
								selectspeed = 0;
						}
						return parseFloat(xpos) - 2 * selectwidth - selectspeed <= d3.select(this).attr("x") && d3.select(this).attr("x") <= (parseFloat(xpos) + (2 * vwidth) + speed);});
				//...or in the lane below you
				var downCars = svg.selectAll("rect[lane='" + (d.lane - 1) + "']").filter(
					function(){
						var select = d3.select(this);
						var data = select.datum();
						var selectwidth = data.width;
						var selectspeed;
						switch(data.status){
							case 0:
							case 2:
								selectspeed = parseFloat(data.speed);
							case 1:
								selectspeed = parseFloat(data.slowspeed);
						}
						return parseFloat(xpos) - 2 * selectwidth - 2 * selectspeed <= d3.select(this).attr("x") && d3.select(this).attr("x") <= (parseFloat(xpos) + (2 * vwidth) + speed);});
				//if there is space in either of the lanes next to you move to that lane
				if(upCars.empty() && d.lane + 1 != lanenumber){
					d.status = 3;
					d.slowspeed = d.speed;
					d.lane += 1
					d3.select(this).attr("lane", function(){return d.lane})}
				else if(downCars.empty() && d.lane != 0){
					d.status = 3;
					d.slowspeed = d.speed;
					d.lane -= 1
					d3.select(this).attr("lane", function(){return d.lane})}
				//otherwise match the speed of the car ahead of you
				else{
					d.status = 1;
					var slowSpeed = d.speed;
					closeCars.each( function(d){	
						if(d.status == 0 && parseFloat(d.speed) < slowSpeed) { slowSpeed = d.speed }
						else if(d.status == 1 && parseFloat(d.slowspeed) < slowSpeed) { slowSpeed = d.slowspeed }
						else if(d.status == 4  && parseFloat(d.slowingscale(d.disttonextcar)) < slowSpeed) { slowSpeed = parseFloat(d.slowingscale(d.disttonextcar))}});
					d.slowspeed = slowSpeed;}}
 			});}
 	
 	function deleteVehicles(){
 		for(var i = 0; i < vehicles.length; i++){
 			var id = "v" + i ;
 			var select = svg.select("rect#" + id);
 			if(select[0][0] != null){
 			if(parseFloat(select.attr("x")) >= w){
 				var vehicle = createVehicle();
 				vehicles[i] = vehicle
 				select.remove()
 				createNewVehicle(vehicle, id);
 			}}
 		}}
 	
 	function move(){
 		setSpeeds();
  		svg.selectAll("rect").transition()
 			.attr("x", function(d){ 
 				if(d.status == 0){return parseFloat(d3.select(this).attr("x")) + d.speed}
 				if(d.status == 1){return parseFloat(d3.select(this).attr("x")) + d.slowspeed}
 				if(d.status == 2 || d.status == 3 ){return parseFloat(d3.select(this).attr("x"))}
 			.attr("y", function(d){return yscale(d.lane)})
 			.duration(duration)
 			.each("end", deleteVehicles());
 	}
 	
 	function createNewVehicle(data, id){
 		svg.append("rect")
 			.datum(data)
 			.attr("id", id)
 			.attr("x", -35)
 			.attr("y", function(d){return yscale(d.lane)})
 			.attr("lane", function(d){return d.lane})
 			.attr("width", function(d){return d.width})
 			.attr("height", function(d){return d.height})
 			.style("color", function(d){return d.color})
 			.style("stroke", function(d){return d.stroke})
 			.style("stroke-width", function(d){return d.strokewidth})
 			.attr("fill", function(d){return d.color});
 	}
 	
 	setInterval(move, duration)
 	
</script>
</body>
 		
 
 	